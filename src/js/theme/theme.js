// FluentUI Web Components tokens
export const webLightTheme = {
  name: "light",
  label: "Light",
  emoji: "☀️",
  colorNeutralBackground1: "#ffffff",
  colorNeutralBackground1Hover: "#f5f5f5",
  colorNeutralBackground1Selected: "#e0e0e0",
  colorNeutralBackground2: "#f5f5f5",
  colorNeutralBackground3: "#f0f0f0",
  colorNeutralBackground4: "#e0e0e0",
  colorNeutralForeground1: "#242424",
  colorNeutralForeground2: "#605e5c",
  colorNeutralForeground3: "#929292",
  colorBrandBackground: "#0078d4",
  colorBrandBackgroundHover: "#106ebe",
  colorBrandBackgroundPressed: "#005a9e",
  colorNeutralForegroundOnBrand: "#ffffff",
  colorNeutralStroke1: "#d1d1d1",
  colorNeutralStrokeAccessible: "#616161",
  colorTransparentBackground: "rgba(0, 0, 0, 0.4)",
  colorStatusSuccess: "#107C10",
  fontFamilyBase: "'Segoe UI', sans-serif",
  fontSizeBase100: "10px",
  fontSizeBase200: "12px",
  fontSizeBase300: "14px",
  fontSizeBase400: "16px",
  fontSizeBase500: "20px",
  fontSizeBase600: "24px",
  fontWeightRegular: "400",
  fontWeightMedium: "500",
  fontWeightSemibold: "600",
  fontWeightBold: "700",
  strokeWidthThin: "1px",
  borderRadiusSmall: "2px",
  borderRadiusMedium: "4px",
  borderRadiusLarge: "8px",
  borderRadiusXLarge: "12px",
  spacingVerticalXXS: "2px",
  spacingVerticalXS: "4px",
  spacingVerticalS: "8px",
  spacingVerticalM: "12px",
  spacingVerticalL: "16px",
  spacingVerticalXL: "20px",
  spacingVerticalXXL: "44px",
  spacingHorizontalXXS: "4px",
  spacingHorizontalXS: "6px",
  spacingHorizontalS: "8px",
  spacingHorizontalM: "12px",
  spacingHorizontalL: "20px",
  shadow4: "0 1.6px 3.6px 0 rgba(0, 0, 0, 0.13), 0 0.3px 0.9px 0 rgba(0, 0, 0, 0.11)",
  shadow8: "0 8px 16px rgba(0, 0, 0, 0.14)",
  shadow16: "0 8px 16px rgba(0, 0, 0, 0.14)"
};

export const webDarkTheme = {
  name: "dark",
  label: "Dark",
  emoji: "🌙",
  colorNeutralBackground1: "#292929",
  colorNeutralBackground1Hover: "#3d3d3d",
  colorNeutralBackground1Selected: "#4d4d4d",
  colorNeutralBackground2: "#3d3d3d",
  colorNeutralBackground3: "#4d4d4d",
  colorNeutralBackground4: "#555555",
  colorNeutralForeground1: "#ffffff",
  colorNeutralForeground2: "#d6d6d6",
  colorNeutralForeground3: "#adadad",
  colorBrandBackground: "#2899f5",
  colorBrandBackgroundHover: "#3aa0f3",
  colorBrandBackgroundPressed: "#168ad2",
  colorNeutralForegroundOnBrand: "#ffffff",
  colorNeutralStroke1: "#666666",
  colorNeutralStrokeAccessible: "#adadad",
  colorTransparentBackground: "rgba(0, 0, 0, 0.6)",
  colorStatusSuccess: "#6CCB5F",
  fontFamilyBase: "'Segoe UI', sans-serif",
  fontSizeBase100: "10px",
  fontSizeBase200: "12px",
  fontSizeBase300: "14px",
  fontSizeBase400: "16px",
  fontSizeBase500: "20px",
  fontSizeBase600: "24px",
  fontWeightRegular: "400",
  fontWeightMedium: "500",
  fontWeightSemibold: "600",
  fontWeightBold: "700",
  strokeWidthThin: "1px",
  borderRadiusSmall: "2px",
  borderRadiusMedium: "4px",
  borderRadiusLarge: "8px",
  borderRadiusXLarge: "12px",
  spacingVerticalXXS: "2px",
  spacingVerticalXS: "4px",
  spacingVerticalS: "8px",
  spacingVerticalM: "12px",
  spacingVerticalL: "16px",
  spacingVerticalXL: "20px",
  spacingVerticalXXL: "44px",
  spacingHorizontalXXS: "4px",
  spacingHorizontalXS: "6px",
  spacingHorizontalS: "8px",
  spacingHorizontalM: "12px",
  spacingHorizontalL: "20px",
  shadow4: "0 1.6px 3.6px 0 rgba(0, 0, 0, 0.30), 0 0.3px 0.9px 0 rgba(0, 0, 0, 0.25)",
  shadow8: "0 8px 16px rgba(0, 0, 0, 0.30)",
  shadow16: "0 8px 16px rgba(0, 0, 0, 0.30)"
};

// Add additional themes
export const blueDarkTheme = {
  name: "blue-dark",
  label: "Blue Dark",
  emoji: "🌃",
  colorNeutralBackground1: "#1b2838",
  colorNeutralBackground1Hover: "#2a3f5a",
  colorNeutralBackground1Selected: "#3a526e",
  colorNeutralBackground2: "#2a3f5a",
  colorNeutralBackground3: "#3a526e",
  colorNeutralBackground4: "#4a6481",
  colorNeutralForeground1: "#ffffff",
  colorNeutralForeground2: "#d6d6d6",
  colorNeutralForeground3: "#adadad",
  colorBrandBackground: "#66c0f4",
  colorBrandBackgroundHover: "#7dcff5",
  colorBrandBackgroundPressed: "#5aace0",
  colorNeutralForegroundOnBrand: "#ffffff",
  colorNeutralStroke1: "#4a6481",
  colorNeutralStrokeAccessible: "#adadad",
  colorTransparentBackground: "rgba(0, 0, 0, 0.6)",
  colorStatusSuccess: "#6CCB5F",
  fontFamilyBase: "'Segoe UI', sans-serif",
  fontSizeBase100: "10px",
  fontSizeBase200: "12px",
  fontSizeBase300: "14px",
  fontSizeBase400: "16px",
  fontSizeBase500: "20px",
  fontSizeBase600: "24px",
  fontWeightRegular: "400",
  fontWeightMedium: "500",
  fontWeightSemibold: "600",
  fontWeightBold: "700",
  strokeWidthThin: "1px",
  borderRadiusSmall: "2px",
  borderRadiusMedium: "4px",
  borderRadiusLarge: "8px",
  borderRadiusXLarge: "12px",
  spacingVerticalXXS: "2px",
  spacingVerticalXS: "4px",
  spacingVerticalS: "8px",
  spacingVerticalM: "12px",
  spacingVerticalL: "16px",
  spacingVerticalXL: "20px",
  spacingVerticalXXL: "44px",
  spacingHorizontalXXS: "4px",
  spacingHorizontalXS: "6px",
  spacingHorizontalS: "8px",
  spacingHorizontalM: "12px",
  spacingHorizontalL: "20px",
  shadow4: "0 1.6px 3.6px 0 rgba(0, 0, 0, 0.30), 0 0.3px 0.9px 0 rgba(0, 0, 0, 0.25)",
  shadow8: "0 8px 16px rgba(0, 0, 0, 0.30)",
  shadow16: "0 8px 16px rgba(0, 0, 0, 0.30)"
};

export const sepiaTheme = {
  name: "sepia",
  label: "Sepia",
  emoji: "📜",
  colorNeutralBackground1: "#f5efe0",
  colorNeutralBackground1Hover: "#ebe5d6",
  colorNeutralBackground1Selected: "#e0dacb",
  colorNeutralBackground2: "#ebe5d6",
  colorNeutralBackground3: "#e0dacb",
  colorNeutralBackground4: "#d5cfc0",
  colorNeutralForeground1: "#5c4b35",
  colorNeutralForeground2: "#6e5b42",
  colorNeutralForeground3: "#8c755a",
  colorBrandBackground: "#8e562e",
  colorBrandBackgroundHover: "#9f673f",
  colorBrandBackgroundPressed: "#7d4519",
  colorNeutralForegroundOnBrand: "#ffffff",
  colorNeutralStroke1: "#cbc0b1",
  colorNeutralStrokeAccessible: "#8c755a",
  colorTransparentBackground: "rgba(92, 75, 53, 0.4)",
  colorStatusSuccess: "#107C10",
  fontFamilyBase: "'Segoe UI', sans-serif",
  fontSizeBase100: "10px",
  fontSizeBase200: "12px",
  fontSizeBase300: "14px",
  fontSizeBase400: "16px",
  fontSizeBase500: "20px",
  fontSizeBase600: "24px",
  fontWeightRegular: "400",
  fontWeightMedium: "500",
  fontWeightSemibold: "600",
  fontWeightBold: "700",
  strokeWidthThin: "1px",
  borderRadiusSmall: "2px",
  borderRadiusMedium: "4px",
  borderRadiusLarge: "8px",
  borderRadiusXLarge: "12px",
  spacingVerticalXXS: "2px",
  spacingVerticalXS: "4px",
  spacingVerticalS: "8px",
  spacingVerticalM: "12px",
  spacingVerticalL: "16px",
  spacingVerticalXL: "20px",
  spacingVerticalXXL: "44px",
  spacingHorizontalXXS: "4px",
  spacingHorizontalXS: "6px",
  spacingHorizontalS: "8px",
  spacingHorizontalM: "12px",
  spacingHorizontalL: "20px",
  shadow4: "0 1.6px 3.6px 0 rgba(92, 75, 53, 0.13), 0 0.3px 0.9px 0 rgba(92, 75, 53, 0.11)",
  shadow8: "0 8px 16px rgba(92, 75, 53, 0.14)",
  shadow16: "0 8px 16px rgba(92, 75, 53, 0.14)"
};

// Export all themes as a collection
export const allThemes = [
  webLightTheme,
  webDarkTheme,
  blueDarkTheme,
  sepiaTheme
];

// setTheme utility function
export function setTheme(theme) {
  const root = document.documentElement;
  
  // Apply theme tokens to CSS variables
  Object.entries(theme).forEach(([token, value]) => {
    // Skip metadata properties
    if (!['name', 'label', 'emoji'].includes(token)) {
      root.style.setProperty(`--${token}`, value);
    }
  });
  
  // Add a data attribute to indicate current theme
  root.setAttribute('data-theme', theme.name || 'light');
  
  // Store the theme name in localStorage
  try {
    localStorage.setItem('preferred-theme', theme.name);
  } catch (e) {
    console.error('Could not save theme preference:', e);
  }
}

// Debug function to check if CSS variables are applied correctly
export function debugTheme() {
  const styles = getComputedStyle(document.documentElement);
  const themeVars = [
    'colorNeutralBackground1',
    'colorBrandBackground',
    'colorNeutralForeground1'
  ];
  
  console.log('Theme variables:');
  themeVars.forEach(varName => {
    console.log(`--${varName}: ${styles.getPropertyValue('--' + varName)}`);
  });
}

// Initialize theme management
export function initializeTheme(debug = false) {
  console.log('Initializing theme management...');
  
  // Check if the preferred color scheme is dark
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  // Try to get saved theme preference
  let savedThemeName = null;
  try {
    savedThemeName = localStorage.getItem('preferred-theme');
    console.log('Saved theme preference:', savedThemeName);
  } catch (e) {
    console.error('Error accessing localStorage:', e);
  }
  
  // Find the theme to apply
  let themeToApply = webLightTheme; // Default
  
  if (savedThemeName) {
    // Try to find the saved theme
    const foundTheme = allThemes.find(theme => theme.name === savedThemeName);
    if (foundTheme) {
      themeToApply = foundTheme;
    }
  } else if (prefersDark) {
    // If no saved preference, use system preference
    themeToApply = webDarkTheme;
  }
  
  // Apply the theme
  setTheme(themeToApply);
  
  // Listen for changes to the preferred color scheme if no saved preference
  if (!savedThemeName) {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      setTheme(e.matches ? webDarkTheme : webLightTheme);
    });
  }
  
  // Debug theme if requested
  if (debug) {
    debugTheme();
    
    // Observe DOM changes for debugging
    const observer = new MutationObserver(() => {
      console.log('DOM visually updated, debugging theme again...');
      debugTheme();
    });
    
    // Start observing document body for changes
    document.addEventListener('DOMContentLoaded', () => {
      observer.observe(document.body, {
        attributes: true,
        childList: false,
        subtree: false
      });
      
      // Set a timeout to check theme again after all scripts have loaded
      setTimeout(() => {
        console.log('Delayed theme check:');
        debugTheme();
      }, 1000);
    });
  }
  
  return themeToApply; // Return the applied theme
}

/**
 * Create and initialize theme selector dropdown.
 * 
 * IMPORTANT NOTES FOR CHROME EXTENSION DEVELOPMENT:
 * 1. This function uses DOM manipulation to create a theme dropdown menu
 * 2. Due to Content Security Policy (CSP) restrictions in Chrome extensions:
 *    - Avoid inline scripts completely
 *    - Always use external JS files
 *    - Never use eval() or new Function()
 *    - Ensure manifest.json has proper CSP configuration:
 *      "content_security_policy": {
 *        "extension_pages": "script-src 'self'; object-src 'self'"
 *      }
 * 3. When debugging theme issues:
 *    - Check browser console for CSP violations
 *    - Verify that all script files are properly loaded
 *    - Make sure DOM is fully loaded before manipulating it
 * 4. For theme customization:
 *    - Add new themes to the allThemes array in this file
 *    - Each theme must have name, label, and emoji properties
 *    - All CSS variables must be defined for each theme
 * 
 * @param {string} buttonId - ID of the theme toggle button
 */
export function setupThemeToggle(buttonId = 'theme-toggle-btn') {
  document.addEventListener('DOMContentLoaded', () => {
    try {
      console.log('Setting up theme toggle with button ID:', buttonId);
      
      const themeToggleBtn = document.getElementById(buttonId);
      if (!themeToggleBtn) {
        console.error(`Theme toggle button with ID "${buttonId}" not found`);
        return;
      }
      console.log('Theme toggle button found:', themeToggleBtn);
      
      // Get current theme from localStorage or system preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      let currentThemeName = prefersDark ? 'dark' : 'light';
      
      try {
        const savedTheme = localStorage.getItem('preferred-theme');
        if (savedTheme) {
          currentThemeName = savedTheme;
          console.log('Using saved theme preference:', savedTheme);
        }
      } catch (e) {
        console.error('Error accessing localStorage:', e);
      }
      
      // Find the current theme object
      let currentTheme = allThemes.find(theme => theme.name === currentThemeName);
      if (!currentTheme) {
        console.log('Theme not found in allThemes, using default');
        currentTheme = prefersDark ? webDarkTheme : webLightTheme;
      }
      
      console.log('Current theme:', currentTheme);
      
      // Check if theme menu already exists and remove it
      const existingMenu = themeToggleBtn.parentElement.querySelector('.theme-menu');
      if (existingMenu) {
        existingMenu.remove();
        console.log('Removed existing theme menu');
      }
      
      // Create theme menu container
      const themeMenu = document.createElement('div');
      themeMenu.className = 'theme-menu';
      themeMenu.style.display = 'none';
      
      // Add theme options to menu
      allThemes.forEach(theme => {
        const option = document.createElement('div');
        option.className = 'theme-option';
        
        if (theme.name === currentTheme.name) {
          option.classList.add('active');
        }
        
        option.innerHTML = `<span>${theme.emoji}</span> <span>${theme.label}</span>`;
        
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Selected theme:', theme.name);
          
          currentTheme = theme;
          setTheme(theme);
          
          // Update button appearance
          themeToggleBtn.textContent = theme.emoji;
          themeToggleBtn.setAttribute('title', `Current theme: ${theme.label}`);
          
          // Hide menu
          themeMenu.style.display = 'none';
          
          // Update selected option styling
          Array.from(themeMenu.children).forEach(opt => {
            if (opt === option) {
              opt.classList.add('active');
            } else {
              opt.classList.remove('active');
            }
          });
        });
        
        themeMenu.appendChild(option);
      });
      
      // Position and insert the theme menu
      const themeToggleContainer = themeToggleBtn.parentElement;
      if (!themeToggleContainer) {
        console.error('Theme toggle button has no parent element!');
        return;
      }
      
      themeToggleContainer.style.position = 'relative';
      themeToggleContainer.appendChild(themeMenu);
      
      // Set initial button appearance
      themeToggleBtn.textContent = currentTheme.emoji;
      themeToggleBtn.setAttribute('title', `Current theme: ${currentTheme.label}`);
      
      // Toggle menu on button click
      themeToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('Theme toggle button clicked');
        
        if (themeMenu.style.display === 'none') {
          themeMenu.style.display = 'block';
        } else {
          themeMenu.style.display = 'none';
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', () => {
        themeMenu.style.display = 'none';
      });
      
      console.log('Theme toggle setup completed successfully');
    } catch (error) {
      console.error('Error setting up theme toggle:', error);
    }
  });
}